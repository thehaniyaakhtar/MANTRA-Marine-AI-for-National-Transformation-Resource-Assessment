<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMLRE Marine Platform Prototype</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 30px; border-radius: 10px; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .metric-card h3 { color: #1e3c72; margin-bottom: 10px; font-size: 2em; }
        .charts { margin: 30px 0; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container { height: 400px; width: 100%; }
        .control-panel { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        .control-panel select, .control-panel button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .control-panel button { background: #1e3c72; color: white; cursor: pointer; border: none; }
        .control-panel button:hover { background: #2a5298; }
        .analysis-result { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 10px; display: none; }
        .analysis-result.show { display: block; }
        footer { text-align: center; margin-top: 40px; padding: 20px; background: #1e3c72; color: white; border-radius: 10px; }
        .api-links { margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .api-links a { color: #1e3c72; text-decoration: none; margin: 0 10px; font-weight: bold; }
        .api-links a:hover { text-decoration: underline; }
        .loading { text-align: center; color: #666; font-style: italic; }
        @media (max-width: 768px) { 
            .chart-row { grid-template-columns: 1fr; } 
            .control-panel { flex-direction: column; align-items: stretch; } 
            header h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåä CMLRE Marine Living Resources Platform</h1>
            <p><strong>Prototype v0.1</strong> | India EEZ Fisheries Analysis ({{ years_range }})</p>
        </header>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>{{ years_count }}</h3>
                <p>Years Covered</p>
            </div>
            <div class="metric-card">
                <h3>{{ species_count }}</h3>
                <p>Fish Categories</p>
            </div>
            <div class="metric-card">
                <h3>{{ record_count }}</h3>
                <p>Total Records</p>
            </div>
            <div class="metric-card">
                <h3>{{ "{:,.0f}".format(total_catch) }}</h3>
                <p>Total Catch (tonnes)</p>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart-row">
                <div class="chart-card">
                    <h3>üìà Catch Trends <span class="loading" id="timeseries-loading">Loading...</span></h3>
                    <div id="timeseries-chart" class="chart-container"></div>
                </div>
                <div class="chart-card">
                    <h3>üîó Ocean-Fisheries Correlations <span class="loading" id="correlation-loading">Loading...</span></h3>
                    <div id="correlation-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <label for="species-select"><strong>üéØ Analyze Species:</strong></label>
            <select id="species-select">
                {% for species in top_species %}
                <option value="{{ species }}">{{ species }}</option>
                {% endfor %}
            </select>
            <button onclick="analyzeSpecies()">üîç Analyze Trends</button>
        </div>
        
        <div id="species-analysis" class="analysis-result">
            <h4 id="species-title"></h4>
            <div id="species-metrics"></div>
        </div>
        
        <div class="api-links">
            <h3>üîå Live API Endpoints</h3>
            <p>
                <a href="/api/data" target="_blank">üìä /api/data</a> |
                <a href="/api/correlations" target="_blank">üîó /api/correlations</a> |
                <a href="/api/visualize/timeseries" target="_blank">üìà /api/visualize/timeseries</a>
            </p>
            <small><em>Click to test APIs in new tabs</em></small>
        </div>
    </div>
    
    <footer>
        <p><em>CMLRE Prototype | Integrated Sea Around Us & CMLRE Survey Data</em></p>
        <p><small>Ministry of Earth Sciences, Government of India | Prototype v0.1</small></p>
    </footer>

    <script>
        // Global variables
        let isLoading = false;

        // Load everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåä CMLRE Prototype loaded');
            loadCharts();
        });

        // Load both charts
        function loadCharts() {
            loadTimeseries();
            loadCorrelations();
        }

        // Load timeseries chart
        function loadTimeseries() {
            const loadingEl = document.getElementById('timeseries-loading');
            loadingEl.textContent = 'Loading chart...';
            
            fetch('/api/visualize/timeseries')
                .then(response => response.json())
                .then(data => {
                    loadingEl.style.display = 'none';
                    if (data.error) {
                        document.getElementById('timeseries-chart').innerHTML = 
                            `<p style="color: red; text-align: center;">Error: ${data.error}</p>`;
                        return;
                    }
                    
                    try {
                        const plotData = JSON.parse(data.plot);
                        Plotly.newPlot('timeseries-chart', plotData.data, plotData.layout, {
                            responsive: true
                        });
                    } catch (e) {
                        console.error('Plotly error:', e);
                        document.getElementById('timeseries-chart').innerHTML = 
                            '<p style="color: orange;">Chart rendering failed</p>';
                    }
                })
                .catch(error => {
                    loadingEl.style.display = 'none';
                    console.error('Fetch error:', error);
                    document.getElementById('timeseries-chart').innerHTML = 
                        '<p style="color: red;">Failed to load chart</p>';
                });
        }

        // Load correlation heatmap
        function loadCorrelations() {
            const loadingEl = document.getElementById('correlation-loading');
            loadingEl.textContent = 'Analyzing correlations...';
            
            fetch('/api/visualize/correlations')
                .then(response => response.json())
                .then(data => {
                    loadingEl.style.display = 'none';
                    if (data.error) {
                        document.getElementById('correlation-chart').innerHTML = 
                            `<p style="color: red; text-align: center;">Error: ${data.error}</p>`;
                        return;
                    }
                    
                    try {
                        const plotData = JSON.parse(data.plot);
                        Plotly.newPlot('correlation-chart', plotData.data, plotData.layout, {
                            responsive: true
                        });
                    } catch (e) {
                        console.error('Correlation plot error:', e);
                        document.getElementById('correlation-chart').innerHTML = 
                            '<p style="color: orange;">Correlation chart unavailable</p>';
                    }
                })
                .catch(error => {
                    loadingEl.style.display = 'none';
                    console.error('Correlation fetch error:', error);
                    document.getElementById('correlation-chart').innerHTML = 
                        '<p style="color: red;">Failed to load correlations</p>';
                });
        }

        // Analyze selected species
        function analyzeSpecies() {
            if (isLoading) return;
            isLoading = true;
            
            const species = document.getElementById('species-select').value;
            const analysisDiv = document.getElementById('species-analysis');
            const titleEl = document.getElementById('species-title');
            const metricsEl = document.getElementById('species-metrics');
            
            // Show loading state
            analysisDiv.classList.add('show');
            titleEl.innerHTML = `<strong>${species}</strong> Analysis`;
            metricsEl.innerHTML = '<p class="loading">Analyzing trends...</p>';
            
            fetch(`/api/trends/${encodeURIComponent(species)}`)
                .then(response => response.json())
                .then(data => {
                    isLoading = false;
                    if (data.error) {
                        metricsEl.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                        return;
                    }
                    
                    const trendColor = data.trend_percent > 0 ? 'green' : data.trend_percent < 0 ? 'red' : 'gray';
                    const trendIcon = data.trend_percent > 0 ? 'üìà' : data.trend_percent < 0 ? 'üìâ' : '‚û°Ô∏è';
                    
                    metricsEl.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div class="metric-card">
                                <h4>${trendIcon} Trend</h4>
                                <p style="color: ${trendColor}; font-size: 1.2em; font-weight: bold;">
                                    ${data.trend_percent > 0 ? '+' : ''}${data.trend_percent}%
                                </p>
                                <small>Over entire period</small>
                            </div>
                            <div class="metric-card">
                                <h4>üèîÔ∏è Peak Year</h4>
                                <p style="font-size: 1.2em; font-weight: bold;">${data.peak_year}</p>
                                <small>Highest catch recorded</small>
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4>üìä Latest Catch</h4>
                            <p style="font-size: 1.1em;">${Math.round(data.total_catch).toLocaleString()} tonnes</p>
                            <small>${data.data[data.data.length-1].Year}</small>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                            <small><strong>Trend Direction:</strong> ${data.trend_direction}</small>
                        </div>
                    `;
                })
                .catch(error => {
                    isLoading = false;
                    console.error('Species analysis error:', error);
                    metricsEl.innerHTML = '<p style="color: red;">Failed to analyze species</p>';
                });
        }

        // Auto-analyze first species on load (optional)
        setTimeout(() => {
            if (document.getElementById('species-select').value) {
                analyzeSpecies();
            }
        }, 2000);
    </script>
</body>
</html>